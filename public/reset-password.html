<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restablecer Contraseña - Sistema ETR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/information.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon/favicon.svg" />
    <link rel="shortcut icon" href="favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Sistema ETR" />
    <link rel="manifest" href="favicon/site.webmanifest" />

    <style>
        #message-area-es,
        #message-area-en {
            display: none;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100" data-bs-theme="dark">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="assets/images/logo.webp" alt="Logo Sistema ETR" width="30" height="30" class="me-2 rounded-3">
                SISTEMA ETR
            </a>
            <a href="index.html" class="btn btn-outline-light d-lg-none" id="nav-home-button">Inicio</a>
        </div>
    </nav>

    <main class="container text-page-container py-5 flex-grow-1">

        <div id="lang-es" style="display: none;">
            <h1 class="font-heading">Restablecer Contraseña</h1>
            <p class="text-muted">Ingresa tu nueva contraseña para la cuenta.</p>

            <form id="reset-password-form-es">
                <div class="mb-3 position-relative">
                    <label for="new-password-es" class="form-label">Nueva Contraseña</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="new-password-es" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-password-es"><i
                                class="bi bi-eye-slash"></i></button>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label for="confirm-password-es" class="form-label">Confirmar Contraseña</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="confirm-password-es" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password-es"><i
                                class="bi bi-eye-slash"></i></button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-xl mt-3"
                    style="font-family: var(--font-heading);">Guardar Contraseña</button>
            </form>

            <div id="message-area-es" class="alert mt-4" role="alert">
            </div>
        </div>

        <div id="lang-en" style="display: none;">
            <h1 class="font-heading">Reset Password</h1>
            <p class="text-muted">Enter your new password for the account.</p>

            <form id="reset-password-form-en">
                <div class="mb-3 position-relative">
                    <label for="new-password-en" class="form-label">New Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="new-password-en" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-password-en"><i
                                class="bi bi-eye-slash"></i></button>
                    </div>
                </div>
                <div class="mb-3 position-relative">
                    <label for="confirm-password-en" class="form-label">Confirm New Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="confirm-password-en" required minlength="6">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-confirm-password-en"><i
                                class="bi bi-eye-slash"></i></button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-xl mt-3" style="font-family: var(--font-heading);">Save
                    Password</button>
            </form>

            <div id="message-area-en" class="alert mt-4" role="alert">
            </div>
        </div>
    </main>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="assets/js/scripts.js"></script>

    <script src="/__/firebase/8.10.1/firebase-app.js"></script>
    <script src="/__/firebase/8.10.1/firebase-auth.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Language Detection
            const langEs = document.getElementById('lang-es');
            const langEn = document.getElementById('lang-en');
            const htmlTag = document.documentElement;
            const titleTag = document.querySelector('title');
            const userLang = navigator.language.substring(0, 2);

            let form, passwordInput, confirmPasswordInput, messageArea, messages;

            if (userLang === 'es') {
                htmlTag.lang = 'es';
                titleTag.textContent = 'Restablecer Contraseña - Sistema ETR';
                langEs.style.display = 'block';

                // Set variables for Spanish elements
                form = document.getElementById('reset-password-form-es');
                passwordInput = document.getElementById('new-password-es');
                confirmPasswordInput = document.getElementById('confirm-password-es');
                messageArea = document.getElementById('message-area-es');
                messages = {
                    invalidCode: 'Error: El enlace es inválido o ha expirado. Por favor, solicita uno nuevo.',
                    success: '¡Contraseña actualizada con éxito! Ya puedes iniciar sesión con tu nueva contraseña.',
                    weakPassword: 'Error: La contraseña es demasiado débil (debe tener al menos 6 caracteres).',
                    mismatch: 'Error: Las contraseñas no coinciden.',
                    error: 'Error: No se pudo restablecer la contraseña. El enlace puede haber expirado.'
                };
            } else {
                htmlTag.lang = 'en';
                titleTag.textContent = 'Reset Password - Sistema ETR';
                langEn.style.display = 'block';

                // Set variables for English elements
                form = document.getElementById('reset-password-form-en');
                passwordInput = document.getElementById('new-password-en');
                confirmPasswordInput = document.getElementById('confirm-password-en');
                messageArea = document.getElementById('message-area-en');
                messages = {
                    invalidCode: 'Error: The link is invalid or has expired. Please request a new one.',
                    success: 'Password updated successfully! You can now log in with your new password.',
                    weakPassword: 'Error: The password is too weak (must be at least 6 characters).',
                    mismatch: 'Error: The passwords do not match.',
                    error: 'Error: Could not reset password. The link may have expired.'
                };
            }

            // Helper function to toggle password visibility
            function setupPasswordToggle(inputId, buttonId) {
                const passwordField = document.getElementById(inputId);
                const toggleButton = document.getElementById(buttonId);
                const icon = toggleButton.querySelector('i');

                toggleButton.addEventListener('click', function () {
                    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordField.setAttribute('type', type);
                    icon.classList.toggle('bi-eye');
                    icon.classList.toggle('bi-eye-slash');
                });
            }

            // Setup toggles for both languages and fields
            setupPasswordToggle('new-password-es', 'toggle-password-es');
            setupPasswordToggle('confirm-password-es', 'toggle-confirm-password-es');
            setupPasswordToggle('new-password-en', 'toggle-password-en');
            setupPasswordToggle('confirm-password-en', 'toggle-confirm-password-en');

            // Get the action code from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const actionCode = urlParams.get('oobCode');

            // Helper function to show messages
            function showMessage(text, type) {
                messageArea.textContent = text;
                messageArea.className = 'alert mt-4';
                if (type === 'success') {
                    messageArea.classList.add('alert-success');
                } else {
                    messageArea.classList.add('alert-danger');
                }
                messageArea.style.display = 'block';
            }

            // SECURITY CHECK: If no code, block access
            if (!actionCode) {
                showMessage(messages.invalidCode, 'danger');
                form.style.display = 'none';
                return;
            }

            // Verify the code is valid first
            firebase.auth().verifyPasswordResetCode(actionCode).then((email) => {
                // Code is valid
            }).catch((error) => {
                // Invalid or expired code
                showMessage(messages.invalidCode, 'danger');
                form.style.display = 'none';
            });

            // Add submit event listener to the form
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const newPassword = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showMessage(messages.mismatch, 'danger');
                    return;
                }

                // Call confirmPasswordReset to update the password
                firebase.auth().confirmPasswordReset(actionCode, newPassword).then((resp) => {
                    // Password has been reset successfully
                    showMessage(messages.success, 'success');
                    form.style.display = 'none';

                }).catch((error) => {
                    // Handle errors
                    console.error(error);
                    if (error.code === 'auth/weak-password') showMessage(messages.weakPassword, 'danger');
                    else showMessage(messages.error, 'danger');
                });
            });
        });
    </script>

</body>

</html>